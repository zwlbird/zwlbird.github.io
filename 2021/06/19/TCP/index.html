<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TCP | .oOo.</title><meta name="keywords" content="TCP"><meta name="author" content="Smt"><meta name="copyright" content="Smt"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TCP–UDP​        TCP提供了一个完全可靠的，面向连接的，全双工的（包含两个独立且方向相反的连接）流传输服务，允许两个应用程序建立一个连接，并在全双工的方向上发送数据，然后终止连接。每一个TCP连接都可靠的简历连接并完善的终止，在终止发生前，所有数据都会被可靠地传送。​        TCP通信的客户端和服务端每次通信都会有3次握手的过程，这3次握手，确保数据能够准确地发送到对方。T">
<meta property="og:type" content="article">
<meta property="og:title" content="TCP">
<meta property="og:url" content="https://zwlbird.github.io/2021/06/19/TCP/index.html">
<meta property="og:site_name" content=".oOo.">
<meta property="og:description" content="TCP–UDP​        TCP提供了一个完全可靠的，面向连接的，全双工的（包含两个独立且方向相反的连接）流传输服务，允许两个应用程序建立一个连接，并在全双工的方向上发送数据，然后终止连接。每一个TCP连接都可靠的简历连接并完善的终止，在终止发生前，所有数据都会被可靠地传送。​        TCP通信的客户端和服务端每次通信都会有3次握手的过程，这3次握手，确保数据能够准确地发送到对方。T">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/06/19/geAVYp3HfN7Kvb6.jpg">
<meta property="article:published_time" content="2021-06-19T13:25:24.000Z">
<meta property="article:modified_time" content="2022-10-31T09:03:11.308Z">
<meta property="article:author" content="Smt">
<meta property="article:tag" content="TCP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/06/19/geAVYp3HfN7Kvb6.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zwlbird.github.io/2021/06/19/TCP/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TCP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-31 17:03:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2021/06/19/geAVYp3HfN7Kvb6.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">.oOo.</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TCP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-19T13:25:24.000Z" title="发表于 2021-06-19 21:25:24">2021-06-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-31T09:03:11.308Z" title="更新于 2022-10-31 17:03:11">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TCP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/06/19/TCP/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/06/19/TCP/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="TCP–UDP"><a href="#TCP–UDP" class="headerlink" title="TCP–UDP"></a>TCP–UDP</h1><p>​        TCP提供了一个完全可靠的，面向连接的，全双工的（包含两个独立且方向相反的连接）流传输服务，允许两个应用程序建立一个连接，并在全双工的方向上发送数据，然后终止连接。每一个TCP连接都可靠的简历连接并完善的终止，在终止发生前，所有数据都会被可靠地传送。<br>​        TCP通信的客户端和服务端每次通信都会有3次握手的过程，这3次握手，确保数据能够准确地发送到对方。TCP通信是分为客户端和服务端的。</p>
<span id="more"></span>

<h2 id="TCP-Server-构建流程"><a href="#TCP-Server-构建流程" class="headerlink" title="TCP Server 构建流程"></a>TCP Server 构建流程</h2><p><img src="/2021/06/19/TCP/image-20210620150516236.png" alt="image-20210620150516236"></p>
<h2 id="TCP-client-构建流程"><a href="#TCP-client-构建流程" class="headerlink" title="TCP client 构建流程"></a>TCP client 构建流程</h2><p><img src="/2021/06/19/TCP/image-20210620150550615.png" alt="image-20210620150550615"></p>
<h2 id="Windows下API简介"><a href="#Windows下API简介" class="headerlink" title="Windows下API简介"></a>Windows下API简介</h2><h3 id="1-WSAStartup"><a href="#1-WSAStartup" class="headerlink" title="1 . WSAStartup"></a>1 . WSAStartup</h3><p>该函数用于初始化Ws2_32.dll动态链接库，在使用socket之前，一定要初始化该链接库。<br>初始化：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WSADATA wsaData;</span><br><span class="line"><span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData)<span class="comment">//第一个参数表示winsock的版本，本例使用的是winsock2.2版本。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-socket"><a href="#2-socket" class="headerlink" title="2 . socket"></a>2 . socket</h3><p>创建一个socket</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//af:一个地址家族，通常为AF_INET</span></span><br><span class="line"><span class="comment">//type:套接字类型，SOCK_STREAM表示创建面向流连接的套接字。为SOCK_DGRAM，表示创建面向无连接的数据包套接字。为SOCK_RAW，表示创建原始套接字</span></span><br><span class="line">    <span class="comment">//SOCK_STREAM Tcp 连接，提供序列化的、可靠的、双向连接的字节流。支持带外数据传输</span></span><br><span class="line">    <span class="comment">//SOCK_DGRAM 支持 UDP 连接（无连接状态的消息）</span></span><br><span class="line">    <span class="comment">//SOCK_SEQPACKET 序列化包，提供一个序列化的、可靠的、双向的基本连接的数据传输通道，数据长度定常。每次调用读系统调用时数据需要将全部数据读出</span></span><br><span class="line">    <span class="comment">//SOCK_RAW RAW 类型，提供原始网络协议访问</span></span><br><span class="line">    <span class="comment">//SOCK_RDM 提供可靠的数据报文，不过可能数据会有乱序</span></span><br><span class="line">    <span class="comment">//SOCK_PACKET 这是一个专用类型，不能呢过在通用程序中使用</span></span><br><span class="line"><span class="comment">//返回值就是一个socket</span></span><br><span class="line"><span class="function">SOCKET <span class="title">socket</span><span class="params">(<span class="keyword">int</span> af,<span class="keyword">int</span> type,<span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-bind"><a href="#3-bind" class="headerlink" title="3 . bind"></a>3 . bind</h3><p>该函数用于将套接字绑定到指定的端口和地址。<br>第一个参数为socket，第二个参数是一个结构指针，它包含了端口和IP地址信息，第三个参数表示缓冲区长度。需要说明的是，第二个参数在API中表示为：const struct sockaddr FAR*,这个语法结构我还没见过，网上说这是远指针，win16时期的产物，算是长见识了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SOCKADDR_IN addrSrv;</span><br><span class="line"> addrSrv.sin_family = AF_INET;</span><br><span class="line"> addrSrv.sin_port = <span class="built_in">htons</span>(<span class="number">8888</span>); <span class="comment">//1024以上的端口号</span></span><br><span class="line"> addrSrv.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//IP地址</span></span><br><span class="line"> <span class="built_in">bind</span>(sockSrv, (LPSOCKADDR)&amp;addrSrv, <span class="built_in"><span class="keyword">sizeof</span></span>(SOCKADDR_IN));</span><br></pre></td></tr></table></figure>

<h3 id="4-listen"><a href="#4-listen" class="headerlink" title="4 . listen"></a>4 . listen</h3><p>将socket设置为监听模式，服务端的socket特有。必须将服务端的socket设置为监听模式才能和服务端简历连接。<br>里面有两个参数，第一个参数为socket，第二个参数为等待连接最大队列的长度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen(sockSrv,10)</span><br></pre></td></tr></table></figure>

<h3 id="5-accept"><a href="#5-accept" class="headerlink" title="5 . accept"></a>5 . accept</h3><p>服务端socket接收客户端的连接请求，连接成功，则返回一个socket，该socket可以在服务端发送和接收数据。第一个参数为socket，第二个参数为包含客户端端口IP信息的sockaddr_in结构指针，第三个参数为接收参数addr的长度。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> len = <span class="built_in"><span class="keyword">sizeof</span></span>(SOCKADDR);</span><br><span class="line"><span class="built_in">accept</span>(sockSrv, (SOCKADDR *) &amp;addrClient, &amp;len);</span><br></pre></td></tr></table></figure>

<h3 id="6-closesocket"><a href="#6-closesocket" class="headerlink" title="6 . closesocket"></a>6 . closesocket</h3><p>关闭socket，里面的唯一的一个参数就是要关闭的socket。<br>7 . connect函数：客户端socket发送连接请求的函数，第一个参数是客户端的socket，第二个参数是一个结构体指针，里面包括连接主机的地址和ip，第三个参数为缓冲区的长度。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">connect</span>(sockClient, (struct  sockaddr*)&amp;addrSrv, <span class="built_in"><span class="keyword">sizeof</span></span>(addrSrv));</span><br></pre></td></tr></table></figure>

<h3 id="8-htons"><a href="#8-htons" class="headerlink" title="8 . htons"></a>8 . htons</h3><p>将一个16位无符号短整型数据由主机排列方式转化为网络排列方式，htonl函数的作用恰好相反。</p>
<h3 id="9-recv"><a href="#9-recv" class="headerlink" title="9 . recv"></a>9 . recv</h3><p>接收数据，第一个参数为socket，第二个参数为接收数据缓冲区，第三个参数为缓冲区的长度，第四个参数为函数的调用方式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buff[<span class="number">1024</span>];</span><br><span class="line"><span class="built_in">recv</span>(sockClient, buff, <span class="built_in"><span class="keyword">sizeof</span></span>(buff), <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="10-send"><a href="#10-send" class="headerlink" title="10 . send"></a>10 . send</h3><p>发送数据，里面的参数基本和recv（）一样。</p>
<h3 id="11-ioctlsocket"><a href="#11-ioctlsocket" class="headerlink" title="11 . ioctlsocket()"></a>11 . ioctlsocket()</h3><p>设置 socket 的模式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctlsocket</span><span class="params">( <span class="keyword">int</span> s, <span class="keyword">long</span> cmd, u_long * argp)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//s：一个标识套接口的描述字。 </span></span><br><span class="line"><span class="comment">//cmd：对套接口 s 的操作命令。 </span></span><br><span class="line"><span class="comment">//argp：指向 cmd 命令所带参数的指针。</span></span><br><span class="line"></span><br><span class="line">cmd参数：</span><br><span class="line"></span><br><span class="line">	FIONBIO： </span><br><span class="line">	允许或禁止套接口 s 的非阻塞模式。argp 指向一个无符号长整型，如允许非阻塞模式则非零，如禁止非阻塞模式则为零。当创建一个套接口时，它就处于阻塞模式（也就是说非阻塞模式被禁止）。这与 BSD 套接口是一致的。<span class="built_in">WSAAsyncSelect</span> () 函数将套接口自动设置为非阻塞模式。如果已对一个套接口进行了 <span class="built_in">WSAAsyncSelect</span> () 操作，则任何用 <span class="built_in">ioctlsocket</span> () 来把套接口] 重新设置成阻塞模式的试图将以 WSAEINVAL 失败。为了把套接口重新设置成阻塞模式，应用程序必须首先用 <span class="built_in">WSAAsyncSelect</span> () 调用（IEvent 参数置为 <span class="number">0</span>）来禁止 <span class="built_in">WSAAsyncSelect</span> ()。 </span><br><span class="line">    </span><br><span class="line">    FIONREAD：</span><br><span class="line">	确定套接口 s 自动读入的数据量。argp 指向一个无符号长整型，其中存有 <span class="built_in">ioctlsocket</span> () 的返回值。如果 s 是 SOCKET_STREAM 类型，则 FIONREAD 返回在一次 <span class="built_in">recv</span> () 中所接收的所有数据量。这通常与套接口中排队的数据总量相同。如果 S 是 SOCK_DGRAM 型，则 FIONREAD 返回套接口上排队的第一个数据报大小。 </span><br><span class="line">    </span><br><span class="line">    SIOCATMARK：</span><br><span class="line">	确认是否所有的带外数据都已被读入。这个命令仅适用于 SOCK_STREAM 类型的套接口，且该套接口已被设置为可以在线接收带外数据（SO_OOBINLINE）。如无带外数据等待读入，则该操作返回 TRUE 真。否则的话返回 FALSE 假，下一个 <span class="built_in">recv</span> () 或 <span class="built_in">recvfrom</span> () 操作将检索 “标记” 前一些或所有数据。应用程序可用 SIOCATMARK 操作来确定是否有数据剩下。如果在 “紧急”（带外）数据 [前有常规数据，则按序接收这些数据（请注意，<span class="built_in">recv</span> () 和 <span class="built_in">recvfrom</span> () 操作不会在一次调用中混淆常规数据与带外数] 据）。argp 指向一个 BOOL 型数，<span class="built_in">ioctlsocket</span> () 在其中存入返回值。 </span><br></pre></td></tr></table></figure>

<p>设置非阻塞： </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>); </span><br><span class="line">u_long mode = <span class="number">1</span>; </span><br><span class="line"><span class="built_in">ioctlsocket</span>(sockfd, FIONBIO, &amp;mode);<span class="comment">//设置非阻塞</span></span><br></pre></td></tr></table></figure>

<h3 id="12-端口复用"><a href="#12-端口复用" class="headerlink" title="12.端口复用"></a>12.端口复用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> optval = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">setsockopt</span>(pudp_recv-&gt;udp_recv_sd, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">char</span>*)&amp;optval , <span class="built_in"><span class="keyword">sizeof</span></span>(optval)) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(pudp_recv-&gt;s_message,<span class="string">&quot;SetSocketOption:setsockopt(SO_REUSEADDR) error!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">QAbstractSocket::bind</span><span class="params">(<span class="keyword">const</span> QHostAddress &amp;address, quint16 port = <span class="number">0</span>, BindMode mode = DefaultForPlatform)</span></span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">QAbstractSocket::bind</span><span class="params">(quint16 port = <span class="number">0</span>, BindMode mode = DefaultForPlatform)</span></span></span><br><span class="line"><span class="function">    设置mode 为 QAbstractSocket::ReuseAddressHint即可</span></span><br></pre></td></tr></table></figure>

<h3 id="13-组播"><a href="#13-组播" class="headerlink" title="13.组播"></a>13.组播</h3><h4 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">mreq</span>;</span><span class="comment">/*本机IP加入广播组*/</span></span><br><span class="line">mreq.imr_multiaddr.s_addr = <span class="built_in">inet_addr</span>(Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">valS</span>(<span class="string">&quot;AISNAVIP&quot;</span>).<span class="built_in">c_str</span>());<span class="comment">//广播地址</span></span><br><span class="line">mreq.imr_interface.s_addr = <span class="built_in">htonl</span>(INADDR_ANY); <span class="comment">//网络接口为默认</span></span><br><span class="line"><span class="comment">/*将本机加入广播组*/</span></span><br><span class="line"><span class="keyword">int</span> err = <span class="built_in">setsockopt</span>(sockClient, IPPROTO_IP, IP_ADD_MEMBERSHIP, (<span class="keyword">char</span>*)&amp;mreq, <span class="built_in"><span class="keyword">sizeof</span></span>(mreq));</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//QMessageBox::warning(NULL, &quot;Tip&quot;, QString::fromLocal8Bit(&quot;加入广播组错误！&quot;));</span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">void</span> *)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*退出广播组*/</span></span><br><span class="line"><span class="keyword">int</span> err = <span class="built_in">setsockopt</span>(sockClient, IPPROTO_IP, IP_DROP_MEMBERSHIP, (<span class="keyword">char</span>*)&amp;mreq, <span class="built_in"><span class="keyword">sizeof</span></span>(mreq));</span><br></pre></td></tr></table></figure>

<h4 id="Qt"><a href="#Qt" class="headerlink" title="Qt"></a>Qt</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">QString listernIp, <span class="keyword">int</span> listernPort, QString destinationIp, <span class="keyword">int</span> destinationPort;</span><br><span class="line"></span><br><span class="line"><span class="comment">//看是在什么情况下构造的，在线程中构造，需要在线程中释放，即以槽函数响应slot_deleteThread，否则，直接调用slot_deleteThread</span></span><br><span class="line">m_socket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(m_listernIp.<span class="built_in">toString</span>().<span class="built_in">length</span>()&gt;<span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ip_addr3_int =m_listernIp.<span class="built_in">toString</span>().<span class="built_in">split</span>(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].<span class="built_in">toInt</span>();</span><br><span class="line">    <span class="keyword">if</span>(ip_addr3_int&gt;=<span class="number">224</span> &amp;&amp; ip_addr3_int&lt;=<span class="number">239</span>)<span class="comment">//ip地址前3个数为224~239则为组播  224.0.0.0-239.255.255.255</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!m_socket-&gt;<span class="built_in">bind</span>(m_listernIp, m_listernPort ,QUdpSocket::ShareAddress))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">joinMulticastGroup</span>(<span class="built_in">QHostAddress</span>(m_listernIp)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;joinMulticastGroup error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">bind</span>(m_listernIp, m_listernPort ,QUdpSocket::ShareAddress))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="封装TCPServer–Qt-C"><a href="#封装TCPServer–Qt-C" class="headerlink" title="封装TCPServer–Qt+C++"></a>封装TCPServer–Qt+C++</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtCore/QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;QtCore/QThread&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="comment">//没有下面这句，所有的通讯函数都将报错</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//必须链接这个库</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCP_C_Server</span> :</span> <span class="keyword">public</span> QThread</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TCP_C_Server</span>(<span class="keyword">const</span> QString &amp;hostName, <span class="keyword">int</span> port, QString tcpname, QObject *parent=<span class="literal">NULL</span>);</span><br><span class="line">    ~<span class="built_in">TCP_C_Server</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//外部调用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="comment">//线程接收client消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recv_thread</span><span class="params">(QByteArray &amp;v)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> m_run = <span class="literal">true</span>;<span class="comment">//是否退出</span></span><br><span class="line">    vector&lt;vector&lt;QString&gt;&gt; m_socket;<span class="comment">//最多支持8个连接</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QString m_hostName;</span><br><span class="line">    quint16 m_port;</span><br><span class="line"></span><br><span class="line">    QString m_connName;<span class="comment">//当前TCP的名称</span></span><br><span class="line">    <span class="keyword">int</span> m_connectCnt = <span class="number">0</span>;<span class="comment">//连接状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd=<span class="number">-1</span>;<span class="comment">//TCP</span></span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="comment">//内部中转，用线程发出去</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMessage</span><span class="params">(QByteArray str)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//内部client数据发送给外部</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_TCPreceive</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="comment">//日志发送外部显示</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendlog</span><span class="params">(string)</span></span>;</span><br><span class="line">    <span class="comment">//连接状态发送外部显示，个数+名称</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendConStatus</span><span class="params">(<span class="keyword">int</span>, QString)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">//内部中转，用线程发出去</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_sendMsg</span><span class="params">(QByteArray array)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCP_C_Server.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 在一个新的线程里面接收数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Fun</span><span class="params">(<span class="keyword">void</span>  *param,<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TCP_C_Server *ptr = (TCP_C_Server *)param;</span><br><span class="line">    <span class="keyword">int</span> sockConn = ptr-&gt;m_socket[index][<span class="number">0</span>].<span class="built_in">toInt</span>();</span><br><span class="line">    <span class="keyword">char</span> *recvBuf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ptr-&gt;m_socket[index][<span class="number">0</span>] == <span class="string">&quot;-1&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ptr-&gt;m_run)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(recvBuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvBuf));</span><br><span class="line">        <span class="comment">//      //接收数据</span></span><br><span class="line">        ret = <span class="built_in">recv</span>(sockConn, recvBuf, <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        ptr-&gt;<span class="built_in">recv_thread</span>(<span class="built_in">QByteArray</span>(recvBuf, ret));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;index = %d\n&quot;</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> []recvBuf;</span><br><span class="line">    emit ptr-&gt;<span class="built_in">signal_sendlog</span>(<span class="string">&quot;break&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;break ,index = %d\n&quot;</span>, index);</span><br><span class="line">    <span class="built_in">closesocket</span>(sockConn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TCP_C_Server::<span class="built_in">TCP_C_Server</span>(<span class="keyword">const</span> QString &amp;hostName, <span class="keyword">int</span> port, QString tcpname, QObject *parent):<span class="built_in">QThread</span>()</span><br><span class="line">&#123;</span><br><span class="line">    qRegisterMetaType&lt;std::string&gt;(<span class="string">&quot;std::string&quot;</span>);</span><br><span class="line">    m_hostName = hostName;</span><br><span class="line">    <span class="keyword">if</span> (m_hostName.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        m_hostName = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_port = port;</span><br><span class="line">    m_connName = tcpname;</span><br><span class="line"></span><br><span class="line">    m_socket.<span class="built_in">resize</span>(<span class="number">8</span>, vector&lt;QString&gt;(<span class="number">3</span>,<span class="string">&quot;-1&quot;</span>));</span><br><span class="line">    <span class="comment">//构造函数中run</span></span><br><span class="line">    <span class="comment">//    start();</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;TCP_C_Server:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TCP_C_Server::~<span class="built_in">TCP_C_Server</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(m_socket[i][<span class="number">0</span>].<span class="built_in">toInt</span>());</span><br><span class="line">        m_socket[i][<span class="number">0</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">        m_socket[i][<span class="number">1</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">        m_socket[i][<span class="number">2</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(sockfd);</span><br><span class="line">    sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//构造函数中run</span></span><br><span class="line">    <span class="comment">//    this-&gt;quit();</span></span><br><span class="line">    <span class="comment">//	this-&gt;wait();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCP_C_Server::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;slot_startThread:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="comment">//内部中转，用线程发出去</span></span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMessage</span>(QByteArray)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_sendMsg</span>(QByteArray)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    WSADATA wsa;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsa) != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsa.wVersion) != <span class="number">2</span> || <span class="built_in">HIBYTE</span>(wsa.wVersion) != <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; Tcp socket error\n&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nRecvBuf = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span>;<span class="comment">//设置为1MB</span></span><br><span class="line">    <span class="keyword">int</span> setoptret = <span class="built_in">setsockopt</span>(sockfd, SOL_SOCKET, SO_SNDBUF, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;nRecvBuf, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">    setoptret = <span class="built_in">setsockopt</span>(sockfd, SOL_SOCKET, SO_RCVBUF, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;nRecvBuf, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == setoptret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; Tcp setsockopt SO_RCVBUF fail!\n&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct sockaddr_in));</span><br><span class="line">    peeraddr.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">//注意：linux要bind组播地址,而不是自己网卡的地址</span></span><br><span class="line">    peeraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(m_hostName.<span class="built_in">toStdString</span>().<span class="built_in">c_str</span>());<span class="comment">// htonl(INADDR_ANY); //inet_addr(udpReturnSrcIp);//inet_addr(config_file.udpReturnSrcIp);//htonl(INADDR_ANY); //inet_addr(&quot;192.168.1.153&quot;); //htonl(INADDR_ANY);</span></span><br><span class="line">    peeraddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bindRet = ::<span class="built_in">bind</span>(sockfd, (struct sockaddr *)(&amp;peeraddr), <span class="built_in"><span class="keyword">sizeof</span></span>(struct sockaddr));</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == bindRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; Tcp bind port error INADDR_ANY&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bindRet = <span class="built_in">listen</span>(sockfd, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (bindRet == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; Tcp listen error&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; wait Tcp for client linked in  &quot;</span> + std::to_string(m_port) + <span class="string">&quot;,&quot;</span> + m_hostName.toStdString())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> lenaccept = <span class="built_in"><span class="keyword">sizeof</span></span>(struct sockaddr_in);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">c_address</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (m_run)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_socket[i][<span class="number">0</span>] == <span class="string">&quot;-1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (sockfd == <span class="number">-1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> _soc= <span class="built_in">accept</span>(sockfd, (sockaddr *)(&amp;c_address), &amp;lenaccept);</span><br><span class="line">                <span class="keyword">if</span> (_soc &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_socket[i][<span class="number">0</span>] = QString::<span class="built_in">number</span>(_soc);</span><br><span class="line">                    m_socket[i][<span class="number">1</span>] = QString::<span class="built_in">fromLocal8Bit</span>(<span class="built_in">inet_ntoa</span>(c_address.sin_addr));</span><br><span class="line">                    m_socket[i][<span class="number">2</span>] = QString::<span class="built_in">number</span>(<span class="built_in">htons</span>(c_address.sin_port));</span><br><span class="line">                    <span class="function">emit <span class="title">signal_sendlog</span><span class="params">( m_connName.toStdString() +<span class="string">&quot; tcp &quot;</span> + m_socket[i][<span class="number">1</span>].toStdString() + <span class="string">&quot;:&quot;</span> + m_socket[i][<span class="number">2</span>].toStdString() + <span class="string">&quot; init success&quot;</span>)</span></span>;</span><br><span class="line">                    <span class="function">emit <span class="title">signal_sendConStatus</span><span class="params">(++m_connectCnt, m_connName)</span></span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//新开线程接收数据</span></span><br><span class="line">                    <span class="function">std::thread <span class="title">second</span><span class="params">(Fun, <span class="keyword">this</span>, i)</span></span>;</span><br><span class="line">                    second.<span class="built_in">detach</span>();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCP_C_Server::sendMessage</span><span class="params">(QByteArray v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;sendMessage:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="keyword">if</span> (!m_run) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_socket.<span class="built_in">size</span>() != <span class="number">8</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">emit <span class="title">signal_sendMessage</span><span class="params">(v)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCP_C_Server::recv_thread</span><span class="params">(QByteArray&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;recv_thread &quot;</span> &lt;&lt; v&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="function">emit <span class="title">signal_TCPreceive</span><span class="params">(v)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCP_C_Server::slot_sendMsg</span><span class="params">(QByteArray data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;slot_sendMsg:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="keyword">if</span> (!m_run) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>*recvBuf = data.<span class="built_in">data</span>();</span><br><span class="line">    <span class="keyword">int</span> len = data.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_socket[i][<span class="number">0</span>] != <span class="string">&quot;-1&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">send</span>(m_socket[i][<span class="number">0</span>].<span class="built_in">toInt</span>(), (<span class="keyword">char</span> *)recvBuf, len, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="function">emit <span class="title">signal_sendlog</span><span class="params">(m_connName.toStdString() + <span class="string">&quot; tcp &quot;</span> + m_socket[i][<span class="number">1</span>].toStdString() + <span class="string">&quot;:&quot;</span> + m_socket[i][<span class="number">2</span>].toStdString() + <span class="string">&quot;disconnected&quot;</span>)</span></span>;</span><br><span class="line">                m_socket[i][<span class="number">0</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">                m_socket[i][<span class="number">1</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">                m_socket[i][<span class="number">2</span>] = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">                <span class="function">emit <span class="title">signal_sendConStatus</span><span class="params">(--m_connectCnt, m_connName)</span></span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="怎么使用"><a href="#怎么使用" class="headerlink" title="怎么使用"></a>怎么使用</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TCPSERVERCTEST_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCPSERVERCTEST_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTimer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCP_C_Server.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPServerCTest</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">TCPServerCTest</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    QThread *m_thread=<span class="literal">NULL</span>;</span><br><span class="line">    TCP_C_Server *m_pTCPmanager_ais=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//模拟退出</span></span><br><span class="line">    QTimer *m_timer=<span class="literal">NULL</span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMsg</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_deleteThread</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_UDPreceive</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TCPSERVERCTEST_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCPServerCTest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">TCPServerCTest::<span class="built_in">TCPServerCTest</span>(QObject *parent) : <span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    m_thread = <span class="keyword">new</span> QThread;</span><br><span class="line">    m_pTCPmanager_ais = <span class="keyword">new</span> <span class="built_in">TCP_C_Server</span>(<span class="string">&quot;192.168.30.251&quot;</span>, <span class="number">1547</span>,<span class="string">&quot;ais&quot;</span>);</span><br><span class="line">    m_pTCPmanager_ais-&gt;<span class="built_in">moveToThread</span>(m_thread);</span><br><span class="line">    <span class="built_in">connect</span>(m_pTCPmanager_ais, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_TCPreceive</span>(QByteArray)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_UDPreceive</span>(QByteArray)));</span><br><span class="line">    <span class="built_in">connect</span>(m_thread, <span class="built_in">SIGNAL</span>(<span class="built_in">started</span>()), m_pTCPmanager_ais, <span class="built_in">SLOT</span>(<span class="built_in">start</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(m_thread, <span class="built_in">SIGNAL</span>(<span class="built_in">finished</span>()), m_thread, <span class="built_in">SLOT</span>(<span class="built_in">deleteLater</span>()));</span><br><span class="line">    m_thread-&gt;<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模拟发送</span></span><br><span class="line">    m_timer=<span class="keyword">new</span> QTimer;</span><br><span class="line">    <span class="built_in">connect</span>(m_timer, <span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">update</span>()));</span><br><span class="line">    m_timer-&gt;<span class="built_in">start</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;test:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServerCTest::slot_UDPreceive</span><span class="params">(QByteArray value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;QString::<span class="built_in">fromStdString</span>(value.<span class="built_in">toStdString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServerCTest::update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//发送数据</span></span><br><span class="line">    <span class="function">QByteArray <span class="title">test</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>)</span></span>;</span><br><span class="line">    m_pTCPmanager_ais-&gt;<span class="built_in">sendMessage</span>(test);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(cnt++ &gt;<span class="number">10</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_timer-&gt;<span class="built_in">stop</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//释放</span></span><br><span class="line">        m_thread-&gt;<span class="built_in">quit</span>();</span><br><span class="line">        m_thread-&gt;<span class="built_in">wait</span>();</span><br><span class="line">        <span class="keyword">delete</span> m_pTCPmanager_ais;</span><br><span class="line">        m_pTCPmanager_ais=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="封装TCPServer-–-Qt"><a href="#封装TCPServer-–-Qt" class="headerlink" title="封装TCPServer – Qt"></a>封装TCPServer – Qt</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TCPSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCPSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QThread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpSocket&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpServer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tcpclientsocket.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;structheader.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//tcpserver界面显示当前连接属性</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NetMes</span>&#123;</span></span><br><span class="line">    qintptr m_description=<span class="number">-1</span>;</span><br><span class="line">    QString m_clientIP=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> m_clientPort=<span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPServer</span> :</span> <span class="keyword">public</span> QTcpServer</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TCPServer</span>(QString hostName, <span class="keyword">int</span> port,QObject *parent=<span class="literal">NULL</span>);</span><br><span class="line">    ~<span class="built_in">TCPServer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QList&lt;TcpClientSocket*&gt; m_socket_list;</span><br><span class="line">    QList&lt;NetMes&gt; m_signalLlist;</span><br><span class="line">    QString m_hostName;</span><br><span class="line">    quint16 m_port;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">//client连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">incomingConnection</span><span class="params">(qintptr  socketDescriptor)</span></span>;<span class="comment">//只要出现一个新的连接，就会自动调用这个函数</span></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">//接收client数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_getMessage</span><span class="params">(QByteArray,QString,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    <span class="comment">//client主动断开连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_clientdisconnect</span><span class="params">(qintptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//外部向client发送数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_sendMessage</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="comment">//外部向某个client发送数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_sendMessage</span><span class="params">(QByteArray,QString,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    <span class="comment">//外部断开监听</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_Disconnected</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//server主动断开连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_Serverdisconnect</span><span class="params">(QString,QString)</span></span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="comment">//发送至外部</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_TCPreceive</span><span class="params">(QByteArray,QString,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    <span class="comment">//连接状态发送界面显示</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_ServerStatus</span><span class="params">(QList&lt;NetMes&gt;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">getclinetcount</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> m_socket_list.<span class="built_in">size</span>();&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TCPSERVER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCPServer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">TCPServer::<span class="built_in">TCPServer</span>(QString hostName, <span class="keyword">int</span> port,QObject *parent):<span class="built_in">QTcpServer</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    qDebug()&lt;&lt;&quot;TCPServer:&quot;&lt;&lt;QThread::currentThreadId();</span></span><br><span class="line">    m_hostName = hostName;</span><br><span class="line">    <span class="keyword">if</span>(m_hostName.<span class="built_in">isEmpty</span>())&#123;</span><br><span class="line">        m_hostName=QHostAddress::Any;</span><br><span class="line">    &#125;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="built_in">listen</span>(<span class="built_in">QHostAddress</span>(m_hostName), m_port); <span class="comment">//监听</span></span><br><span class="line">    qRegisterMetaType&lt;qintptr&gt;(<span class="string">&quot;qintptr&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TCPServer::~<span class="built_in">TCPServer</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::incomingConnection</span><span class="params">(qintptr  socketDescriptor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    qDebug()&lt;&lt;&quot;incomingConnection:&quot;&lt;&lt;QThread::currentThreadId();</span></span><br><span class="line">    TcpClientSocket *tcpclientsocket = <span class="keyword">new</span> <span class="built_in">TcpClientSocket</span>();<span class="comment">//只要有新的连接就生成一个新的通信套接字</span></span><br><span class="line">    <span class="comment">//将新创建的通信套接字描述符指定为参数socketdescriptor</span></span><br><span class="line">    tcpclientsocket-&gt;<span class="built_in">setSocketDescriptor</span>(socketDescriptor);</span><br><span class="line">    tcpclientsocket-&gt;m_description=socketDescriptor;</span><br><span class="line">    tcpclientsocket-&gt;m_clientIP = tcpclientsocket-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toString</span>();</span><br><span class="line">    tcpclientsocket-&gt;m_clientPort=tcpclientsocket-&gt;<span class="built_in">peerPort</span>();</span><br><span class="line">    <span class="comment">//将这个套接字加入客户端套接字列表中</span></span><br><span class="line">    m_socket_list.<span class="built_in">append</span>(tcpclientsocket);</span><br><span class="line"></span><br><span class="line">    NetMes _net;</span><br><span class="line">    _net.m_description=socketDescriptor;</span><br><span class="line">    _net.m_clientIP = tcpclientsocket-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toString</span>();</span><br><span class="line">    _net.m_clientPort=tcpclientsocket-&gt;<span class="built_in">peerPort</span>();</span><br><span class="line">    m_signalLlist.<span class="built_in">append</span>(_net);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收到tcpclientsocket发送过来的信号</span></span><br><span class="line">    <span class="built_in">connect</span>(tcpclientsocket, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMessage</span>(QByteArray,QString,<span class="keyword">int</span>)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_getMessage</span>(QByteArray,QString,<span class="keyword">int</span>)));</span><br><span class="line">    <span class="built_in">connect</span>(tcpclientsocket, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_clientdisconnected</span>(qintptr)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_clientdisconnect</span>(qintptr)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function">emit <span class="title">signal_ServerStatus</span><span class="params">(m_signalLlist)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt;<span class="string">&quot;A Client connect!&quot;</span>&lt;&lt;socketDescriptor&lt;&lt;<span class="string">&quot;,current list size is &quot;</span>&lt;&lt;m_socket_list.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_getMessage</span><span class="params">(QByteArray msg,QString ip,<span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    qDebug()&lt;&lt;&quot;slot_getMessage:&quot;&lt;&lt;msg.size();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将这个信号发送给外部</span></span><br><span class="line">    <span class="function">emit <span class="title">signal_TCPreceive</span><span class="params">(msg ,ip,port)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在list中移除，销毁实际是在 TcpSocket 中触发销毁的时候就已经销毁了</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_clientdisconnect</span><span class="params">(qintptr descriptor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;slot_clientdisconnect:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket_list.<span class="built_in">count</span>(); )</span><br><span class="line">    &#123;</span><br><span class="line">        TcpClientSocket *item = m_socket_list.<span class="built_in">at</span>(i);</span><br><span class="line">        <span class="keyword">if</span>(item-&gt;m_description == descriptor)</span><br><span class="line">        &#123;</span><br><span class="line">            m_socket_list[i]-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">            m_socket_list[i]-&gt;<span class="built_in">close</span>();</span><br><span class="line">            m_socket_list[i]-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">            m_socket_list.<span class="built_in">removeAt</span>(i);<span class="comment">//如果有客户端断开连接， 就将列表中的套接字删除</span></span><br><span class="line">            m_signalLlist.<span class="built_in">removeAt</span>(i);</span><br><span class="line">            <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;A Client disconnect!&quot;</span>&lt;&lt;descriptor&lt;&lt;<span class="string">&quot;,current list size is &quot;</span>&lt;&lt;m_socket_list.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">emit <span class="title">signal_ServerStatus</span><span class="params">(m_signalLlist)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_Serverdisconnect</span><span class="params">(QString IP,QString port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket_list.<span class="built_in">count</span>(); )</span><br><span class="line">    &#123;</span><br><span class="line">        TcpClientSocket *item = m_socket_list.<span class="built_in">at</span>(i);</span><br><span class="line">        <span class="keyword">if</span>(item-&gt;m_clientIP == IP &amp;&amp; item-&gt;m_clientPort == port.<span class="built_in">toInt</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            m_socket_list[i]-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_sendMessage</span><span class="params">(QByteArray value, QString ip , <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket_list.<span class="built_in">count</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        QTcpSocket *item = m_socket_list.<span class="built_in">at</span>(i);</span><br><span class="line">        <span class="keyword">if</span>(item-&gt;<span class="built_in">isValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(item-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toString</span>()==ip &amp;&amp; item-&gt;<span class="built_in">peerPort</span>()==port)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;dengdadsfasf=&quot;</span>&lt;&lt;QString::<span class="built_in">fromLocal8Bit</span>(value)&lt;&lt;m_socket_list.<span class="built_in">count</span>();</span><br><span class="line">                item-&gt;<span class="built_in">write</span>(value);</span><br><span class="line">                item-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line">                item-&gt;<span class="built_in">flush</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i = 0; i &lt; m_socket_list.count(); i++)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        TcpClientSocket *item = m_socket_list.at(i);</span></span><br><span class="line"><span class="comment">//        if(item-&gt;m_clientIP == ip &amp;&amp; item-&gt;m_clientPort==port)</span></span><br><span class="line"><span class="comment">//        &#123;</span></span><br><span class="line"><span class="comment">//            qDebug()&lt;&lt;&quot;dengdadsfasf=&quot;&lt;&lt;QString::fromLocal8Bit(value);</span></span><br><span class="line"><span class="comment">//            item-&gt;write(value);</span></span><br><span class="line"><span class="comment">//            item-&gt;waitForBytesWritten();</span></span><br><span class="line"><span class="comment">//            item-&gt;flush();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_sendMessage</span><span class="params">(QByteArray msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    qDebug()&lt;&lt;&quot;slot_sendMessage:&quot;&lt;&lt;QThread::currentThreadId();</span></span><br><span class="line">    <span class="comment">//将收到的信息发送给每个客户端,从套接字列表中找到需要接收的套接字</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket_list.<span class="built_in">count</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        QTcpSocket *item = m_socket_list.<span class="built_in">at</span>(i);</span><br><span class="line">        item-&gt;<span class="built_in">write</span>(msg);</span><br><span class="line">        item-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line">        item-&gt;<span class="built_in">flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServer::slot_Disconnected</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;slot_Disconnected:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">    <span class="comment">//取消侦听</span></span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开连接后会响应slot_clientdisconnect槽函数自动删除，所以不用在这删除了</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_socket_list.<span class="built_in">count</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">        QTcpSocket *item = m_socket_list.<span class="built_in">at</span>(i);</span><br><span class="line">        item-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">        item-&gt;<span class="built_in">close</span>();</span><br><span class="line">        item-&gt;<span class="built_in">deleteLater</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用来通信的类TcpClientSocket，用来保存客户端，有几个客户端就需要在server里创建几个，而且客户端的断开需要发送给服务端</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TCPCLIENTSOCKET_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCPCLIENTSOCKET_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpSocket&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpClientSocket</span> :</span> <span class="keyword">public</span> QTcpSocket</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT <span class="comment">//添加这个宏是为了实现信号和槽的通信</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TcpClientSocket</span>(QObject *parent = <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMessage</span><span class="params">(QByteArray)</span></span>;<span class="comment">//用来告诉tcpserver接收的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_clientdisconnected</span><span class="params">(qintptr)</span></span>; <span class="comment">//告诉server有客户端断开连接</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    qintptr m_description=<span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TCPCLIENTSOCKET_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tcpclientsocket.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">TcpClientSocket::<span class="built_in">TcpClientSocket</span>(QObject *parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//客户端发送数据过来就会触发readyRead信号</span></span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QTcpSocket::readyRead, [<span class="keyword">this</span>]()&#123;</span><br><span class="line">        emit <span class="built_in">signal_sendMessage</span>(<span class="built_in">readAll</span>());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, &amp;QTcpSocket::disconnected, [<span class="keyword">this</span>]()&#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; m_description;</span><br><span class="line">        <span class="comment">//调用销毁信号，但是看实际情况，调用这个的时候就销毁了，会导致获取到的描述符为-1， 但是不会影响到其他地方</span></span><br><span class="line">        emit <span class="built_in">signal_clientdisconnected</span>(m_description);        <span class="comment">// 获取socket描述符</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="怎么使用-1"><a href="#怎么使用-1" class="headerlink" title="怎么使用"></a>怎么使用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TCPSERVERTEST_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCPSERVERTEST_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTimer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCPServer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//tcpserver界面显示当前连接属性</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NetMes</span>&#123;</span></span><br><span class="line">    qintptr m_description=<span class="number">-1</span>;</span><br><span class="line">    QString m_clientIP=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> m_clientPort=<span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPServerTest</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">TCPServerTest</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    QThread *m_thread=<span class="literal">NULL</span>;</span><br><span class="line">    TCPServer *m_tcpServer=<span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//模拟退出</span></span><br><span class="line">    QTimer *m_timer=<span class="literal">NULL</span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMsg</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_deleteThread</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//外部向某个client发送数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMessage</span><span class="params">(QByteArray,QString,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    <span class="comment">//server主动断开连接</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_Serverdisconnect</span><span class="params">(QString,QString)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_UDPreceive</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">     <span class="comment">//server连接状态接收并发送界面显示</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_ServerStatus</span><span class="params">(QList&lt;NetMes&gt;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TCPSERVERTEST_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TCPServerTest.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">TCPServerTest::<span class="built_in">TCPServerTest</span>(QObject *parent) : <span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//    在线程中访问</span></span><br><span class="line">    m_thread = <span class="keyword">new</span> QThread;</span><br><span class="line">    m_tcpServer= <span class="keyword">new</span> <span class="built_in">TCPServer</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">14521</span>);</span><br><span class="line">    m_tcpServer-&gt;<span class="built_in">moveToThread</span>(m_thread);</span><br><span class="line">    m_thread-&gt;<span class="built_in">start</span>();</span><br><span class="line">    <span class="built_in">connect</span>(m_tcpServer, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_TCPreceive</span>(QByteArray)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_UDPreceive</span>(QByteArray)));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMsg</span>(QByteArray)), m_tcpServer, <span class="built_in">SLOT</span>(<span class="built_in">slot_sendMessage</span>(QByteArray)));</span><br><span class="line">    qRegisterMetaType&lt;QList&lt;NetMes&gt;&gt;(<span class="string">&quot;QList&lt;NetMes&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">connect</span>(m_tcpServer, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_ServerStatus</span>(QList&lt;NetMes&gt;)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_ServerStatus</span>(QList&lt;NetMes&gt;)));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMessage</span>(QByteArray,QString,<span class="keyword">int</span>)), m_tcpServer, <span class="built_in">SLOT</span>(<span class="built_in">slot_sendMessage</span>(QByteArray,QString,<span class="keyword">int</span>)));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_Serverdisconnect</span>(QString,QString)), m_tcpServer, <span class="built_in">SLOT</span>(<span class="built_in">slot_Serverdisconnect</span>(QString,QString)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//模拟发送</span></span><br><span class="line">    m_timer=<span class="keyword">new</span> QTimer;</span><br><span class="line">    <span class="built_in">connect</span>(m_timer, <span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">update</span>()));</span><br><span class="line">    m_timer-&gt;<span class="built_in">start</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;test:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServerTest::slot_ServerStatus</span><span class="params">(QList&lt;NetMes&gt; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//    qDebug()&lt;&lt;&quot;---------------------------&quot;;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t.<span class="built_in">count</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        NetMes _net= t.<span class="built_in">at</span>(i);</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;++++++++++++++++++==&quot;</span>&lt;&lt;_net.m_clientIP+<span class="string">&quot;:&quot;</span>+QString::<span class="built_in">number</span>(_net.m_clientPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//emit signal_ServerStatus(t);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServerTest::slot_UDPreceive</span><span class="params">(QByteArray value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;QString::<span class="built_in">fromStdString</span>(value.<span class="built_in">toStdString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TCPServerTest::update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//发送数据</span></span><br><span class="line">    <span class="function">QByteArray <span class="title">test</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">emit <span class="title">signal_sendMsg</span><span class="params">(test)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(cnt++ &gt;<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_timer-&gt;<span class="built_in">stop</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//        在线程中释放</span></span><br><span class="line">        <span class="function">emit <span class="title">signal_deleteThread</span><span class="params">()</span></span>;</span><br><span class="line">        m_thread-&gt;<span class="built_in">quit</span>();</span><br><span class="line">        m_thread-&gt;<span class="built_in">wait</span>();</span><br><span class="line">        <span class="keyword">delete</span> m_tcpServer;</span><br><span class="line">        m_tcpServer=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="封装TCPClient-–-Qt"><a href="#封装TCPClient-–-Qt" class="headerlink" title="封装TCPClient – Qt"></a>封装TCPClient – Qt</h2><p> <a href="G:\MyC-Example\TCP_UDP_Example\tcp_thread.zip">tcp_thread.zip</a> </p>
<p>支持断线重连</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TCPMANAGER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCPMANAGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QHostAddress&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QThread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTcpSocket&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTimer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_PTR(PTR) &#123;<span class="meta-keyword">if</span>(PTR)&#123;delete PTR;PTR = nullptr;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tcpmanager</span>:</span><span class="keyword">public</span> QThread</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">tcpmanager</span>(<span class="keyword">const</span> QString &amp;hostName, quint16 port, QObject *parent = <span class="number">0</span>);</span><br><span class="line">    ~<span class="built_in">tcpmanager</span>();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRunOn</span><span class="params">(<span class="keyword">bool</span> run)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_send</span><span class="params">(QByteArray str)</span></span>;</span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">newConnect</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readMessage</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_disconnect</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_connected</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">displayError</span><span class="params">(QAbstractSocket::SocketError)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_timeout</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_sendMessage</span><span class="params">(QByteArray str)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span>  <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="comment">//说明：接受函数触发槽</span></span><br><span class="line">    <span class="comment">//参数：返回字节流。m_Msgdata</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_TCPreceive</span><span class="params">(QByteArray&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMessage</span><span class="params">(QByteArray str)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_stopTCP</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_status</span><span class="params">(<span class="keyword">bool</span>)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QTcpSocket *m_tcp=<span class="literal">nullptr</span>;</span><br><span class="line">    QString m_hostName;</span><br><span class="line">    quint16 m_port;</span><br><span class="line">    QTimer* m_time=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">bool</span> isConnect=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> m_RunOn=<span class="literal">true</span>;<span class="comment">//是否无视模式</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TCPMANAGER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tcpmanager.h&quot;</span></span></span><br><span class="line">tcpmanager::<span class="built_in">tcpmanager</span>(<span class="keyword">const</span> QString &amp;hostName, quint16 port, QObject *parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">moveToThread</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-tcpmanager thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    m_hostName = hostName;</span><br><span class="line">    m_port = port;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tcpmanager::~<span class="built_in">tcpmanager</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-~tcpmanager thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; has delete!&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">quit</span>();</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">wait</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::setRunOn</span><span class="params">(<span class="keyword">bool</span> run)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_RunOn=run;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::readMessage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-readMessage thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    QByteArray all = m_tcp-&gt;<span class="built_in">readAll</span>();</span><br><span class="line">    <span class="keyword">if</span>(all.<span class="built_in">length</span>()&gt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//        qDebug()&lt;&lt;QString::fromLocal8Bit(all);</span></span><br><span class="line">        <span class="keyword">if</span>(m_RunOn)</span><br><span class="line">            <span class="function">emit <span class="title">signal_TCPreceive</span><span class="params">(all)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::slot_sendMessage</span><span class="params">(QByteArray str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-slot_sendMessage thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="keyword">if</span>(isConnect)</span><br><span class="line">    &#123;</span><br><span class="line">        m_tcp-&gt;<span class="built_in">write</span>(str,str.<span class="built_in">length</span>());</span><br><span class="line">        m_tcp-&gt;<span class="built_in">waitForBytesWritten</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::slot_send</span><span class="params">(QByteArray str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-slot_send thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="function">emit <span class="title">signal_sendMessage</span><span class="params">(str)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::slot_disconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-slot_disconnect thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;slot_disconnect&quot;</span>;<span class="comment">//输出错误信息</span></span><br><span class="line">    isConnect = <span class="literal">false</span>;</span><br><span class="line">    <span class="function">emit <span class="title">signal_status</span><span class="params">(<span class="literal">false</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::slot_connected</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-Connected thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;Connected OK.&quot;</span>;</span><br><span class="line">    isConnect = <span class="literal">true</span>;</span><br><span class="line">    <span class="function">emit <span class="title">signal_status</span><span class="params">(<span class="literal">true</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::displayError</span><span class="params">(QAbstractSocket::SocketError)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-displayError thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;m_tcp-&gt;<span class="built_in">errorString</span>();<span class="comment">//输出错误信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::slot_timeout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-slot_timeout thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="keyword">if</span>(!isConnect)&#123;</span><br><span class="line">        m_tcp-&gt;<span class="built_in">abort</span>();<span class="comment">//取消之前的链接</span></span><br><span class="line">        <span class="comment">//查找地址和端口，建立连接</span></span><br><span class="line">        m_tcp-&gt;<span class="built_in">connectToHost</span>(m_hostName,m_port);</span><br><span class="line">        m_tcp-&gt;<span class="built_in">waitForConnected</span>(<span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::newConnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-newConnect thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="keyword">if</span>(isConnect==<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(m_tcp)&#123;</span><br><span class="line">        <span class="keyword">delete</span> m_tcp;</span><br><span class="line">        m_tcp=<span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_tcp = <span class="keyword">new</span> <span class="built_in">QTcpSocket</span>();</span><br><span class="line">    qRegisterMetaType&lt;QAbstractSocket::SocketError&gt;(<span class="string">&quot;QAbstractSocket::SocketError&quot;</span>);</span><br><span class="line">    <span class="built_in">connect</span>(m_tcp,<span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">readMessage</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(m_tcp,<span class="built_in">SIGNAL</span>(<span class="built_in">error</span>(QAbstractSocket::SocketError)),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">displayError</span>(QAbstractSocket::SocketError)));</span><br><span class="line">    <span class="built_in">connect</span>(m_tcp,<span class="built_in">SIGNAL</span>(<span class="built_in">disconnected</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">slot_disconnect</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(m_tcp,<span class="built_in">SIGNAL</span>(<span class="built_in">connected</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">slot_connected</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>,<span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMessage</span>(QByteArray)),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">slot_sendMessage</span>(QByteArray)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcpmanager::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;tcp-run thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">newConnect</span>();</span><br><span class="line">    m_time = <span class="keyword">new</span> <span class="built_in">QTimer</span>();</span><br><span class="line">    <span class="built_in">connect</span>(m_time, <span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_timeout</span>()),Qt::DirectConnection);</span><br><span class="line">    m_time-&gt;<span class="built_in">start</span>(<span class="number">3000</span>);</span><br><span class="line">    <span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; m_time has delete!&quot;</span>;</span><br><span class="line">    m_time-&gt;<span class="built_in">stop</span>();</span><br><span class="line">    <span class="keyword">delete</span> m_time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(m_tcp)&#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; TCP disconnectFromHost!&quot;</span>;</span><br><span class="line">        m_tcp-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; TCP close!&quot;</span>;</span><br><span class="line">        m_tcp-&gt;<span class="built_in">close</span>();</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; TCP delete!&quot;</span>;</span><br><span class="line">        <span class="keyword">delete</span> m_tcp;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;m_hostName&lt;&lt;<span class="string">&quot; TCP nullptr!&quot;</span>;</span><br><span class="line">        m_tcp = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="怎么使用-2"><a href="#怎么使用-2" class="headerlink" title="怎么使用"></a>怎么使用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MAINWINDOW_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAINWINDOW_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMainWindow&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;tcpmanager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span> :</span> <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MainWindow</span><span class="params">(QWidget *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">    ~<span class="built_in">MainWindow</span>();</span><br><span class="line">    tcpmanager *m_HDTTcp= <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">//模拟退出</span></span><br><span class="line">    QTimer *m_timer=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMsg</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_TCPreceive</span><span class="params">(QByteArray&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">on_pushButton_clicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">on_pushButton_2_clicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::MainWindow *ui;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MAINWINDOW_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mainwindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ui_mainwindow.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模拟发送</span></span><br><span class="line">    m_timer=<span class="keyword">new</span> QTimer;</span><br><span class="line">    <span class="built_in">connect</span>(m_timer, <span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">update</span>()));</span><br><span class="line">    m_timer-&gt;<span class="built_in">start</span>(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::slot_TCPreceive</span><span class="params">(QByteArray &amp;value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;MainWindow-slot_TCPreceive thread is &quot;</span>&lt;&lt;QThread::<span class="built_in">currentThread</span>();</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;MainWindow::slot_TCPreceive:&quot;</span>&lt;&lt;value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!m_HDTTcp)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发送数据</span></span><br><span class="line">    <span class="function">QByteArray <span class="title">test</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>)</span></span>;</span><br><span class="line">    m_HDTTcp-&gt;<span class="built_in">slot_send</span>(test);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::on_pushButton_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_HDTTcp = <span class="keyword">new</span> <span class="built_in">tcpmanager</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">5672</span>);</span><br><span class="line">    <span class="built_in">connect</span>(m_HDTTcp, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_TCPreceive</span>(QByteArray&amp;)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_TCPreceive</span>(QByteArray&amp;)), Qt::DirectConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::on_pushButton_2_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">delete</span> m_HDTTcp;</span><br><span class="line">    m_HDTTcp=<span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="封装UDP-Qt"><a href="#封装UDP-Qt" class="headerlink" title="封装UDP-Qt"></a>封装UDP-Qt</h2><p> <a href="TCP%5Cudpmanage.cpp">udpmanage.cpp</a> </p>
<p> <a href="TCP%5Cudpmanage.h">udpmanage.h</a> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> UDPMANAGE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UDPMANAGE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QHostAddress&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QUdpSocket&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QThread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">// UDP 接收端 ， 服务端  监听</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UDPmanage</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//说明：构造函数自动开启监听。 </span></span><br><span class="line">	<span class="comment">//参数： 监听IP,监听端口,发送IP,发送端口。</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">UDPmanage</span><span class="params">(QString myip, <span class="keyword">int</span> myport,  QString groupIP=<span class="string">&quot;&quot;</span> ,QString sendip=<span class="string">&quot;&quot;</span>, <span class="keyword">int</span> senport=<span class="number">10000</span>, QObject *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~<span class="built_in">UDPmanage</span>();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRunOn</span><span class="params">(<span class="keyword">bool</span> run)</span></span>;</span><br><span class="line">    QHostAddress m_groupIP=QHostAddress::Null;</span><br><span class="line">    QHostAddress m_myIp;</span><br><span class="line">    quint16 m_myPort;</span><br><span class="line">    QHostAddress m_Sendip;</span><br><span class="line">    quint16  m_Senport;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">//  接收报文</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">myreceive</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(QByteArray array)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_deleteudp</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//初始化</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">signals:</span><br><span class="line">	<span class="comment">//说明：接受函数触发槽</span></span><br><span class="line">    <span class="comment">//参数：返回字节流。m_Msgdata</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_UDPreceive</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sig_deleteudp</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	QUdpSocket* m_socket;</span><br><span class="line"></span><br><span class="line">    QByteArray m_Msgdata;    <span class="comment">//接受报文内容</span></span><br><span class="line">    <span class="keyword">bool</span> m_RunOn=<span class="literal">false</span>;<span class="comment">//是否无视模式</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// UDPMANAGE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;udpmanage.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QDataStream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QNetworkAddressEntry&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line">UDPmanage::<span class="built_in">UDPmanage</span>(QString myip, <span class="keyword">int</span> myport,QString groupIP ,QString sendip<span class="comment">/*=&quot;&quot;*/</span>, <span class="keyword">int</span> senport<span class="comment">/*=1000*/</span>, QObject *parent <span class="comment">/*= 0*/</span>):<span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    m_socket = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!myip.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//        myip = Cfg::get()-&gt;valS(&quot;LocalIP&quot;).c_str();</span></span><br><span class="line">        <span class="function">QHostAddress <span class="title">Ip</span><span class="params">(myip)</span></span>;</span><br><span class="line">        m_myIp = Ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        m_myIp = QHostAddress::Any;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(groupIP!=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_groupIP=<span class="built_in">QHostAddress</span>(groupIP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_myPort = myport;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sendip.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">QHostAddress <span class="title">Ip</span><span class="params">(sendip)</span></span>;</span><br><span class="line">        m_Sendip = Ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        m_Sendip = QHostAddress::Any;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;UDPmanage&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>()&lt;&lt; endl;</span><br><span class="line">    m_Senport = senport;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>,<span class="built_in">SIGNAL</span>(<span class="built_in">sig_deleteudp</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">slot_deleteudp</span>()),Qt::QueuedConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UDPmanage::~<span class="built_in">UDPmanage</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_socket)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;~UDPmanage&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>()&lt;&lt; endl;</span><br><span class="line">        m_socket-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">        m_socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">        <span class="keyword">delete</span> m_socket;</span><br><span class="line">        m_socket = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::slot_deleteudp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::setRunOn</span><span class="params">(<span class="keyword">bool</span> run)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_RunOn = run;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( m_socket == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_socket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>()&gt;<span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> ip_addr3_int =m_groupIP.<span class="built_in">toString</span>().<span class="built_in">split</span>(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].<span class="built_in">toInt</span>();</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">            <span class="keyword">if</span>(m_groupIP!=QHostAddress::Null)<span class="comment">//ip地址前3个数为224~239则为组播  224.0.0.0-239.255.255.255</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!m_socket-&gt;<span class="built_in">bind</span>(m_groupIP, m_myPort ,QUdpSocket::ReuseAddressHint))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                m_socket-&gt;<span class="built_in">setSocketOption</span>(QAbstractSocket::MulticastLoopbackOption,<span class="number">0</span>);</span><br><span class="line">                QList&lt;QNetworkInterface&gt; list = QNetworkInterface::<span class="built_in">allInterfaces</span>(); <span class="comment">//获取系统里所有的网络接口</span></span><br><span class="line">                foreach(QNetworkInterface intf, list)&#123; <span class="comment">//遍历所有接口</span></span><br><span class="line">                    <span class="comment">//intf.addressEntries()返回此接口拥有的IP地址列表及其相关的网掩码和广播地址。</span></span><br><span class="line">                    foreach(QNetworkAddressEntry entry, intf.<span class="built_in">addressEntries</span>())&#123;</span><br><span class="line">                        <span class="built_in">qDebug</span>()&lt;&lt;entry.<span class="built_in">ip</span>().<span class="built_in">toString</span>();</span><br><span class="line">                        <span class="keyword">if</span> (entry.<span class="built_in">broadcast</span>() != QHostAddress::Null &amp;&amp; entry.<span class="built_in">ip</span>() == m_myIp &amp;&amp; entry.<span class="built_in">ip</span>().<span class="built_in">protocol</span>() == QAbstractSocket::IPv4Protocol)&#123;</span><br><span class="line">                            m_socket-&gt;<span class="built_in">setMulticastInterface</span>(intf);</span><br><span class="line">                            <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">joinMulticastGroup</span>(<span class="built_in">QHostAddress</span>(m_groupIP),intf))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;joinMulticastGroup error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">bind</span>(m_myIp, m_myPort ,QUdpSocket::ReuseAddressHint))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::myreceive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(m_socket-&gt;<span class="built_in">hasPendingDatagrams</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//         qDebug()&lt;&lt;&quot;hasPendingDatagrams!&quot;&lt;&lt;endl;</span></span><br><span class="line">        m_Msgdata.<span class="built_in">resize</span>(m_socket-&gt;<span class="built_in">pendingDatagramSize</span>());</span><br><span class="line">        QHostAddress getIp;</span><br><span class="line">        quint16 getPort;</span><br><span class="line"></span><br><span class="line">        m_socket-&gt;<span class="built_in">readDatagram</span>(m_Msgdata.<span class="built_in">data</span>() ,m_Msgdata.<span class="built_in">size</span>() , &amp;getIp , &amp;getPort );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//         qDebug()&lt;&lt;&quot;hasPendingDatagrams!&quot;&lt;&lt;m_Msgdata&lt;&lt;endl;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//            if(m_RunOn)&#123;</span></span><br><span class="line">        <span class="function">emit <span class="title">signal_UDPreceive</span><span class="params">(m_Msgdata)</span></span>;</span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::sendMsg</span><span class="params">(QByteArray array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_socket-&gt;<span class="built_in">writeDatagram</span>(array , m_Sendip , m_Senport );</span><br><span class="line">    <span class="comment">//qDebug()&lt;&lt;&quot;sendip&quot;&lt;&lt;m_Sendip.toString()&lt;&lt;&quot;port&quot;&lt;&lt;m_Senport;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;udpmanage.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;qapplication.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QDataStream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;CustomConfig.h&gt;</span></span></span><br><span class="line">UDPmanage::<span class="built_in">UDPmanage</span>(QString myip, <span class="keyword">int</span> myport ,QString sendip<span class="comment">/*=&quot;&quot;*/</span>, <span class="keyword">int</span> senport<span class="comment">/*=1000*/</span>, QObject *parent <span class="comment">/*= 0*/</span>):<span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    m_socket = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!myip.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">//        myip = Cfg::get()-&gt;valS(&quot;LocalIP&quot;).c_str();</span></span><br><span class="line">        <span class="function">QHostAddress <span class="title">Ip</span><span class="params">(myip)</span></span>;</span><br><span class="line">        m_myIp = Ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        m_myIp = QHostAddress::Any;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    m_myPort = myport;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sendip.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">QHostAddress <span class="title">Ip</span><span class="params">(sendip)</span></span>;</span><br><span class="line">        m_Sendip = Ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        m_Sendip = QHostAddress::Any;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;UDPmanage&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>()&lt;&lt; endl;</span><br><span class="line">    m_Senport = senport;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>,<span class="built_in">SIGNAL</span>(<span class="built_in">sig_deleteudp</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">slot_deleteudp</span>()),Qt::QueuedConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UDPmanage::~<span class="built_in">UDPmanage</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_socket)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;~UDPmanage&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>()&lt;&lt; endl;</span><br><span class="line">        m_socket-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">        m_socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">        <span class="keyword">delete</span> m_socket;</span><br><span class="line">        m_socket = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::slot_deleteudp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::setRunOn</span><span class="params">(<span class="keyword">bool</span> run)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_RunOn = run;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( m_socket == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_socket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>()&gt;<span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> ip_addr3_int =m_myIp.<span class="built_in">toString</span>().<span class="built_in">split</span>(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].<span class="built_in">toInt</span>();</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">            <span class="keyword">if</span>(ip_addr3_int&gt;=<span class="number">224</span> &amp;&amp; ip_addr3_int&lt;=<span class="number">239</span>)<span class="comment">//ip地址前3个数为224~239则为组播  224.0.0.0-239.255.255.255</span></span><br><span class="line">            &#123;</span><br><span class="line">                string ip= Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">valS</span>(<span class="string">&quot;LocalIP&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span>(!m_socket-&gt;<span class="built_in">bind</span>(<span class="built_in">QHostAddress</span>(QString::<span class="built_in">fromStdString</span>(Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">valS</span>(<span class="string">&quot;LocalIP&quot;</span>))), m_myPort ,QAbstractSocket::ReuseAddressHint))</span><br><span class="line">                &#123;</span><br><span class="line">                    Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">SetLog</span>(<span class="string">&quot;bind error! ip is&quot;</span> + m_myIp.<span class="built_in">toString</span>().<span class="built_in">toStdString</span>());</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">joinMulticastGroup</span>(<span class="built_in">QHostAddress</span>(m_myIp)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">SetLog</span>(<span class="string">&quot;joinMulticastGroup error!&quot;</span>);</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;joinMulticastGroup error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">bind</span>(m_myIp, m_myPort ,QUdpSocket::ReuseAddressHint))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::myreceive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(m_socket-&gt;<span class="built_in">hasPendingDatagrams</span>() )</span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">//         qDebug()&lt;&lt;&quot;hasPendingDatagrams!&quot;&lt;&lt;endl;</span></span><br><span class="line">        m_Msgdata.<span class="built_in">resize</span>(m_socket-&gt;<span class="built_in">pendingDatagramSize</span>());</span><br><span class="line">        QHostAddress getIp;</span><br><span class="line">        quint16 getPort;</span><br><span class="line"></span><br><span class="line">        m_socket-&gt;<span class="built_in">readDatagram</span>(m_Msgdata.<span class="built_in">data</span>() ,m_Msgdata.<span class="built_in">size</span>() , &amp;getIp , &amp;getPort );</span><br><span class="line"></span><br><span class="line"><span class="comment">//         qDebug()&lt;&lt;&quot;hasPendingDatagrams!&quot;&lt;&lt;m_Msgdata&lt;&lt;endl;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(Cfg::<span class="built_in">get</span>()-&gt;<span class="built_in">valI</span>(<span class="string">&quot;DataSource&quot;</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="function">emit <span class="title">signal_UDPreceive</span><span class="params">(m_Msgdata)</span></span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(m_RunOn)&#123;</span><br><span class="line">                emit <span class="built_in">signal_UDPreceive</span>(m_Msgdata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDPmanage::sendMsg</span><span class="params">(QByteArray array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_socket-&gt;<span class="built_in">writeDatagram</span>(array , m_Sendip , m_Senport );</span><br><span class="line">    <span class="comment">//qDebug()&lt;&lt;&quot;sendip&quot;&lt;&lt;m_Sendip.toString()&lt;&lt;&quot;port&quot;&lt;&lt;m_Senport;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="怎么使用-3"><a href="#怎么使用-3" class="headerlink" title="怎么使用"></a>怎么使用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TEST_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTimer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UDPManager.h&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">test</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//线程中使用</span></span><br><span class="line">    UDPManager *m_udpThread = <span class="literal">NULL</span>;</span><br><span class="line">    QThread *m_thread=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//主线程使用</span></span><br><span class="line">    UDPManager *m_udpSingle = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//模拟退出</span></span><br><span class="line">    QTimer *m_timer=<span class="literal">NULL</span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_sendMsg</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signal_deleteThread</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">slot_UDPreceive</span><span class="params">(QByteArray)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// TEST_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;test.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMetaType&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QByteArray&gt;</span></span></span><br><span class="line"></span><br><span class="line">test::<span class="built_in">test</span>(QObject *parent) : <span class="built_in">QObject</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    在线程中访问</span></span><br><span class="line">    m_thread = <span class="keyword">new</span> QThread;</span><br><span class="line">    m_udpThread= <span class="keyword">new</span> <span class="built_in">UDPManager</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1452</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">5521</span>);</span><br><span class="line">    m_udpThread-&gt;<span class="built_in">moveToThread</span>(m_thread);</span><br><span class="line">    <span class="built_in">connect</span>(m_thread, <span class="built_in">SIGNAL</span>(<span class="built_in">started</span>()), m_udpThread, <span class="built_in">SLOT</span>(<span class="built_in">slot_startThread</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(m_thread, <span class="built_in">SIGNAL</span>(<span class="built_in">finished</span>()), m_thread, <span class="built_in">SLOT</span>(<span class="built_in">deleteLater</span>()));</span><br><span class="line">    m_thread-&gt;<span class="built_in">start</span>();</span><br><span class="line">    <span class="built_in">connect</span>(m_udpThread, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_UDPreceive</span>(QByteArray)), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">slot_UDPreceive</span>(QByteArray)));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_sendMsg</span>(QByteArray)), m_udpThread, <span class="built_in">SLOT</span>(<span class="built_in">slot_sendMsg</span>(QByteArray)));</span><br><span class="line">    <span class="built_in">connect</span>(<span class="keyword">this</span>, <span class="built_in">SIGNAL</span>(<span class="built_in">signal_deleteThread</span>()), m_udpThread, <span class="built_in">SLOT</span>(<span class="built_in">slot_deleteThread</span>()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    直接调用</span></span><br><span class="line"><span class="comment">//    m_udpSingle= new UDPManager(&quot;127.0.0.1&quot;,1452,&quot;127.0.0.1&quot;,5521);</span></span><br><span class="line"><span class="comment">//    connect(m_udpSingle, SIGNAL(signal_UDPreceive(QByteArray)), this, SLOT(slot_UDPreceive(QByteArray)));</span></span><br><span class="line"><span class="comment">//    connect(this, SIGNAL(signal_sendMsg(QByteArray)), m_udpSingle, SLOT(slot_sendMsg(QByteArray)));</span></span><br><span class="line"><span class="comment">//    m_udpSingle-&gt;slot_startThread();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//模拟发送</span></span><br><span class="line">    m_timer=<span class="keyword">new</span> QTimer;</span><br><span class="line">    <span class="built_in">connect</span>(m_timer, <span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">update</span>()));</span><br><span class="line">    m_timer-&gt;<span class="built_in">start</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;test:&quot;</span>&lt;&lt;QThread::<span class="built_in">currentThreadId</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test::slot_UDPreceive</span><span class="params">(QByteArray value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收数据</span></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;QString::<span class="built_in">fromStdString</span>(value.<span class="built_in">toStdString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test::update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//发送数据</span></span><br><span class="line">    <span class="function">QByteArray <span class="title">test</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">emit <span class="title">signal_sendMsg</span><span class="params">(test)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(cnt++ &gt;<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_timer-&gt;<span class="built_in">stop</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        在线程中释放</span></span><br><span class="line">        <span class="function">emit <span class="title">signal_deleteThread</span><span class="params">()</span></span>;</span><br><span class="line">        m_thread-&gt;<span class="built_in">quit</span>();</span><br><span class="line">        m_thread-&gt;<span class="built_in">wait</span>();</span><br><span class="line">        <span class="keyword">delete</span> m_udpThread;</span><br><span class="line">        m_udpThread=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        直接释放</span></span><br><span class="line"><span class="comment">//        delete m_udpSingle;</span></span><br><span class="line"><span class="comment">//        m_udpSingle=NULL;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="UDP函数-C"><a href="#UDP函数-C" class="headerlink" title="UDP函数-C++"></a>UDP函数-C++</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2ipdef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;std::string&gt; <span class="title">splitWithStl</span><span class="params">(<span class="keyword">const</span> std::string &amp;str,<span class="keyword">const</span> std::string &amp;pattern)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::string&gt; resVec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span> == str)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> resVec;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//方便截取最后一段数据</span></span><br><span class="line">    std::string strs = str + pattern;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pos = strs.<span class="built_in">find</span>(pattern);</span><br><span class="line">    <span class="keyword">size_t</span> size = strs.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pos != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        std::string x = strs.<span class="built_in">substr</span>(<span class="number">0</span>,pos);</span><br><span class="line">        resVec.<span class="built_in">push_back</span>(x);</span><br><span class="line">        strs = strs.<span class="built_in">substr</span>(pos+<span class="number">1</span>,size);</span><br><span class="line">        pos = strs.<span class="built_in">find</span>(pattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resVec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载套接字库</span></span><br><span class="line">WORD wVersionRequested;</span><br><span class="line">WSADATA wsaData;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">wVersionRequested = <span class="built_in">MAKEWORD</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">err = <span class="built_in">WSAStartup</span>(wVersionRequested, &amp;wsaData);<span class="comment">//错误会返回WSASYSNOTREADY</span></span><br><span class="line"><span class="keyword">if</span>(err != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">1</span> ||     <span class="comment">//低字节为主版本</span></span><br><span class="line">   <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">1</span>)      <span class="comment">//高字节为副版本</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;server is operating!\n\n&quot;</span>);</span><br><span class="line"><span class="comment">//创建用于监听的套接字</span></span><br><span class="line">sockSrv = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,<span class="number">0</span>);<span class="comment">//失败会返回 INVALID_SOCKET</span></span><br><span class="line"><span class="comment">//printf(&quot;Failed. Error Code : %d&quot;,WSAGetLastError())//显示错误信息</span></span><br><span class="line"></span><br><span class="line">SOCKADDR_IN addrSrv;     <span class="comment">//定义sockSrv接收数据包的地址</span></span><br><span class="line">addrSrv.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(m_listernIp.<span class="built_in">data</span>());</span><br><span class="line">addrSrv.sin_family = AF_INET;</span><br><span class="line">addrSrv.sin_port = <span class="built_in">htons</span>(m_listernPort);</span><br><span class="line"></span><br><span class="line">addrClient.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(m_destinationIp.<span class="built_in">data</span>());<span class="comment">//输入你想通信的她（此处是本机内部）</span></span><br><span class="line">addrClient.sin_family = AF_INET;</span><br><span class="line">addrClient.sin_port = <span class="built_in">htons</span>(m_destinationPort);</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否加入多播组</span></span><br><span class="line"><span class="keyword">bool</span> _inMember=<span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span>(m_listernIp.<span class="built_in">length</span>()&gt;<span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">splitWithStl</span>(m_listernIp,<span class="string">&quot;.&quot;</span>).<span class="built_in">size</span>()!=<span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ip_addr3_int =<span class="built_in">atoi</span>(<span class="built_in">splitWithStl</span>(m_listernIp,<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].<span class="built_in">data</span>());</span><br><span class="line">        <span class="keyword">if</span>(ip_addr3_int&gt;=<span class="number">224</span> &amp;&amp; ip_addr3_int&lt;=<span class="number">239</span>)<span class="comment">//ip地址前3个数为224~239则为组播  224.0.0.0-239.255.255.255</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//绑定套接字, 绑定到端口</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">bind</span>(sockSrv,(SOCKADDR*)&amp;addrSrv,<span class="built_in"><span class="keyword">sizeof</span></span>(SOCKADDR))&lt;<span class="number">0</span>)<span class="comment">//会返回一个SOCKET_ERROR</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">mreq</span>;</span><span class="comment">/*本机IP加入广播组*/</span></span><br><span class="line">            mreq.imr_multiaddr.s_addr = <span class="built_in">inet_addr</span>(m_listernIp.<span class="built_in">data</span>());<span class="comment">//广播地址</span></span><br><span class="line">            mreq.imr_interface.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//网络接口为默认</span></span><br><span class="line">            <span class="comment">/*将本机加入广播组*/</span></span><br><span class="line">            <span class="keyword">int</span> err = <span class="built_in">setsockopt</span>(sockSrv, IPPROTO_IP, IP_ADD_MEMBERSHIP, (<span class="keyword">char</span>*)&amp;mreq, <span class="built_in"><span class="keyword">sizeof</span></span>(mreq));</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout&lt;&lt;<span class="string">&quot;joinMulticastGroup error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _inMember=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//绑定套接字, 绑定到端口</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">bind</span>(sockSrv,(SOCKADDR*)&amp;addrSrv,<span class="built_in"><span class="keyword">sizeof</span></span>(SOCKADDR)) &lt; <span class="number">0</span>)<span class="comment">//会返回一个SOCKET_ERROR</span></span><br><span class="line">            &#123;</span><br><span class="line">                std::cout&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_listernIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_listernPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_listernIp:&quot;</span>&lt;&lt;m_listernIp;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SOCKADDR_IN addrClient;   <span class="comment">//用来接收客户端的地址信息</span></span><br><span class="line"><span class="keyword">int</span> len = <span class="built_in"><span class="keyword">sizeof</span></span>(SOCKADDR);</span><br><span class="line"><span class="keyword">char</span> recvBuf[<span class="number">1500</span>];    <span class="comment">//收</span></span><br><span class="line"><span class="keyword">char</span> sendBuf[<span class="number">1500</span>];    <span class="comment">//发</span></span><br><span class="line"><span class="keyword">char</span> tempBuf[<span class="number">1500</span>];    <span class="comment">//存储中间信息数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//等待并数据</span></span><br><span class="line">    <span class="built_in">recvfrom</span>(sockSrv,recvBuf,<span class="number">100</span>,<span class="number">0</span>,(SOCKADDR*)&amp;addrClient,&amp;len);</span><br><span class="line">    cout&lt;&lt;recvBuf&lt;&lt;endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发送数据</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input data: \n&quot;</span>);</span><br><span class="line">    <span class="built_in">gets</span>(sendBuf);</span><br><span class="line">    <span class="built_in">sendto</span>(sockSrv,sendBuf,<span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>,<span class="number">0</span>,(SOCKADDR*)&amp;addrClient,len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//****************************释放************************************</span></span><br><span class="line"><span class="keyword">if</span>(_inMember)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">mreq</span>;</span><span class="comment">/*本机IP加入广播组*/</span></span><br><span class="line">    mreq.imr_multiaddr.s_addr = <span class="built_in">inet_addr</span>(m_listernIp.<span class="built_in">data</span>());<span class="comment">//广播地址</span></span><br><span class="line">    mreq.imr_interface.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//网络接口为默认</span></span><br><span class="line">    <span class="comment">/*退出广播组*/</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(sockSrv, IPPROTO_IP, IP_DROP_MEMBERSHIP, (<span class="keyword">char</span>*)&amp;mreq, <span class="built_in"><span class="keyword">sizeof</span></span>(mreq)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot; leave membership error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">closesocket</span>(sockSrv);</span><br><span class="line"><span class="built_in">WSACleanup</span>();</span><br></pre></td></tr></table></figure>

<h1 id="多网卡下，C-UDP指定源组播收不到流"><a href="#多网卡下，C-UDP指定源组播收不到流" class="headerlink" title="多网卡下，C++UDP指定源组播收不到流"></a>多网卡下，C++UDP指定源组播收不到流</h1><h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><ul>
<li><p>1、检查Linux系统是否接收到组播数据<br>使用tcpdump工具，检查源或者目的地址239.1.1.1:9001的数据包<br>tcpdump -i ens33 host 239.1.1.1 port 9001</p>
</li>
<li><p>2、关闭防火墙<br>暂时关闭：<br>systemctl stop firewalld<br>service iptables stop<br>永久关闭：<br>systemctl disable firewalld<br>chkconfig iptables off</p>
</li>
<li><p>3、修改/etc/sysctl.conf 文件中的 net.ipv4.conf.all.rp_filter 设置成0<br>sysctl -w net.ipv4.conf.all.rp_filter=0<br>echo “0”&gt;/proc/sys/net/ipv4/conf/all/rp_filter</p>
</li>
<li><p>4、添加组播地址路由：<br>route add -net 239.1.1.1 netmask 255.255.255.255 dev ens33</p>
</li>
</ul>
<h2 id="C-1"><a href="#C-1" class="headerlink" title="C++"></a>C++</h2><ul>
<li>首先，指定源组播，linux 和windows编程稍微有些不同：</li>
</ul>
<blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">windows：bind的是接收网卡的地址（local_ip）和组播端口</span><br><span class="line">Linux：bind的是组播地址和组播端口</span><br></pre></td></tr></table></figure>

</blockquote>
<ul>
<li><p>对于一个网卡收流，其他网卡不用收流</p>
<pre><code>      现象1）：组播收不到流。
          原因：&quot;本地网卡的地址&quot;的IP地址是any了，如果默认IP不是要收组播的网卡IP，就会收不到流。
</code></pre>
<p>​              解决方法：把srcMreq.imr_interface.s_addr 改成本地IP，即可收到流。</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq_source</span> <span class="title">srcMreq</span>;</span></span><br><span class="line">srcMreq.imr_multiaddr.s_addr = <span class="built_in">inet_addr</span>(muticast_ip.<span class="built_in">c_str</span>());<span class="comment">//组播地址</span></span><br><span class="line">srcMreq.imr_interface.s_addr = <span class="built_in">inet_addr</span>(local_ip.<span class="built_in">c_str</span>());<span class="comment">//本地网卡的地址</span></span><br><span class="line">srcMreq.imr_sourceaddr.s_addr = <span class="built_in">inet_addr</span>(src_ip.<span class="built_in">c_str</span>());<span class="comment">//组播的指定源地址</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> &gt; <span class="built_in">setsockopt</span>(h_sock, IPPROTO_IP, IP_ADD_SOURCE_MEMBERSHIP, (<span class="keyword">char</span>*)&amp;srcMreq, <span class="built_in"><span class="keyword">sizeof</span></span>(srcMreq)))</span><br><span class="line">&#123;undefined</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;setsockopt IP_ADD_SOURCE_MEMBERSHIP failed, &quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​                现象2) ：可以收到组播流，但是接收一段时间，就收不到了。时间一般是路由器配置查询器的时间的2倍。            </p>
<p>​                            原因：网卡未添加组播路由，所以没有持续发IGMP包，所以路由器查询后，发现没有端口收流，就不继续往端口发流了            </p>
<p>​                                解决方法：route add -net 0.0.0.0 netmask 0.0.0.0 dev eth0 </p>
<ul>
<li><p>其次：对于要多网卡收流</p>
<pre><code>    现象描述：
                网卡1（192.168.100.71） ：可以收到组播地址的流（source 192.168.100.150）；网卡2（192.168.1.171）：收不到组播地址的流（source 192.168.100.150）
</code></pre>
<p>​                    原因： 网卡2发送不了IGMP的包，原因1.171不知道里没有100.150的路由，所以不知道往哪里发送，解决方法：route add -net 192.168.100.150 netmask 255.255.255.255 dev enp1s0f2，这样网卡2可以收到组播包，但是网卡1收不到组播包了。</p>
<p>因此要想多网卡都接收组播流，配置路由就不行了。</p>
<p>​        我还尝试了 sysctl -w net.ipv4.conf.all.rp_filter=2，当把所有网卡的的内核参数都设置2后，网卡enp1s0f2可以收到流了，但是收一段时间后，流就停了，用tcpdump -i enp1s0f2 igmp  -l -n -vv 观察，enp1s0f2仅仅收到交换机发送的igmp查询包，却没有enp1s0f2发送的IGMP的包（只有刚开始加入组的时候有两个IGMP的包，正常情况应该是加入的时候发送两个IGMP包，然后每隔一段时间，再发送一个IGMP包）。</p>
<p>​        后来运行下面的命令，就可以多网卡收流：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.conf.all.rp_filter=<span class="number">0</span></span><br><span class="line">cat /proc/sys/net/ipv4/conf/all/rp_filter</span><br><span class="line"></span><br><span class="line">切记：有几个网卡，就要执行几次sysctl -w net.ipv4.conf.网卡名.rp_filter=<span class="number">0</span>，每个网卡执行一下</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rp_filter参数详细介绍</span><br><span class="line">    rp_filter参数有三个值，<span class="number">0</span>、<span class="number">1</span>、<span class="number">2</span>，具体含义：</span><br><span class="line">    <span class="number">0</span>：不开启源地址校验。</span><br><span class="line">    <span class="number">1</span>：开启严格的反向路径校验。对每个进来的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，  则直接丢弃该数据包。</span><br><span class="line">    <span class="number">2</span>：开启松散的反向路径校验。对每个进来的数据包，校验其源地址是否可达，即反向路径是否能通（通过任意网口），如果反向路径不同，则直接丢弃该数据包</span><br></pre></td></tr></table></figure>


<p>​         如上所示，数据包发到了eth1网卡，如果这时候开启了rp_filter参数，并配置为1，则系统会严格校验数据包的反向路径。从路由表中可以看出，返回响应时数据包要从eth0网卡出，即请求数据包进的网卡和响应数据包出的网卡不是同一个网卡，这时候系统会判断该反向路径不是最佳路径，而直接丢弃该请求数据包。（业务进程也收不到该请求数据包）</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWFnZXMyMDE3LmNuYmxvZ3MuY29tL2Jsb2cvMTIxODA4Ny8yMDE3MDgvMTIxODA4Ny0yMDE3MDgyOTIwMDYyODQwNS0xMDI5NjkxNDgxLnBuZw?x-oss-process=image/format,png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    解决办法：</span><br><span class="line">    <span class="number">1.</span>修改路由表，使响应数据包从eth1出，即保证请求数据包进的网卡和响应数据包出的网卡为同一个网卡。</span><br><span class="line">    <span class="number">2.</span>关闭rp_filter参数。（注意all和<span class="keyword">default</span>的参数都要改）</span><br><span class="line">    <span class="number">1</span>)修改/etc/sysctl.conf文件，然后sysctl -p刷新到内存。</span><br><span class="line">    <span class="number">2</span>)使用sysctl -w直接写入内存：sysctl -w net.ipv4.conf.all.rp_filter=<span class="number">0</span></span><br><span class="line">    <span class="number">3</span>)修改/proc文件系统： echo <span class="string">&quot;0&quot;</span>&gt;/proc/sys/net/ipv4/conf/all/<span class="built_in">rp_filter</span>(需要进入root)</span><br><span class="line">rp_filters参数介绍来自 https:<span class="comment">//www.cnblogs.com/lipengxiang2009/p/7446388.html</span></span><br><span class="line">多网卡收同一个组播流，当rp_filter=<span class="number">0</span>时，每个网卡上收到两份数据</span><br></pre></td></tr></table></figure>

<pre><code>  把socket绑定网卡，让socket接收到该网卡的网络包
</code></pre>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> <span class="title">Ifreq</span>;</span></span><br><span class="line"><span class="built_in">strcpy</span>(Ifreq.ifr_name, <span class="string">&quot;eth0&quot;</span>); <span class="comment">//这里指定使用那块网卡拉流 参数为网卡名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">setsockopt</span>(h_sock, SOL_SOCKET, SO_BINDTODEVICE, (<span class="keyword">char</span> *)&amp;Ifreq, <span class="built_in"><span class="keyword">sizeof</span></span>(Ifreq)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;<span class="function">undefined</span></span><br><span class="line"><span class="function">    <span class="title">perror</span><span class="params">(<span class="string">&quot;setsockopt():SO_BINDTODEVICE&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Qt（Linux）"><a href="#Qt（Linux）" class="headerlink" title="Qt（Linux）"></a>Qt（Linux）</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( m_socket == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_socket = <span class="keyword">new</span> <span class="built_in">QUdpSocket</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>()&gt;<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ip_addr3_int =m_groupIP.<span class="built_in">toString</span>().<span class="built_in">split</span>(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>].<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">if</span>(m_groupIP!=QHostAddress::Null)<span class="comment">//ip地址前3个数为224~239则为组播  224.0.0.0-239.255.255.255</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!m_socket-&gt;<span class="built_in">bind</span>(m_groupIP, m_myPort ,QUdpSocket::ShareAddress))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_socket-&gt;<span class="built_in">setSocketOption</span>(QAbstractSocket::MulticastLoopbackOption,<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//绑定到具体的网卡</span></span><br><span class="line">            QList&lt;QNetworkInterface&gt; list = QNetworkInterface::<span class="built_in">allInterfaces</span>(); <span class="comment">//获取系统里所有的网络接口</span></span><br><span class="line">            foreach(QNetworkInterface intf, list)&#123; <span class="comment">//遍历所有接口</span></span><br><span class="line">                <span class="comment">//intf.addressEntries()返回此接口拥有的IP地址列表及其相关的网掩码和广播地址。</span></span><br><span class="line">                foreach(QNetworkAddressEntry entry, intf.<span class="built_in">addressEntries</span>())&#123;</span><br><span class="line">                    <span class="built_in">qDebug</span>()&lt;&lt;entry.<span class="built_in">ip</span>().<span class="built_in">toString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (entry.<span class="built_in">broadcast</span>() != QHostAddress::Null &amp;&amp; entry.<span class="built_in">ip</span>() == m_myIp &amp;&amp; entry.<span class="built_in">ip</span>().<span class="built_in">protocol</span>() == QAbstractSocket::IPv4Protocol)&#123;</span><br><span class="line">                        m_socket-&gt;<span class="built_in">setMulticastInterface</span>(intf);</span><br><span class="line">                        <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">joinMulticastGroup</span>(<span class="built_in">QHostAddress</span>(m_groupIP),intf))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;joinMulticastGroup error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(m_socket-&gt;<span class="built_in">bind</span>(m_myIp, m_myPort ,QUdpSocket::ShareAddress))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">connect</span>(m_socket , <span class="built_in">SIGNAL</span>(<span class="built_in">readyRead</span>()) , <span class="keyword">this</span>  , <span class="built_in">SLOT</span>(<span class="built_in">myreceive</span>())) ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;bind error!&quot;</span>&lt;&lt;<span class="string">&quot;IP:&quot;</span>&lt;&lt;m_myIp&lt;&lt;<span class="string">&quot;,PORT:&quot;</span>&lt;&lt;m_myPort&lt;&lt;<span class="string">&quot;,ip_addr3_int:&quot;</span>&lt;&lt;ip_addr3_int&lt;&lt;<span class="string">&quot;,m_myIp.toString():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>()&lt;&lt;<span class="string">&quot;,m_myIp.toString().length():&quot;</span>&lt;&lt;m_myIp.<span class="built_in">toString</span>().<span class="built_in">length</span>();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;m_myIp error!&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">SENDERIP = <span class="string">&#x27;192.168.30.10&#x27;</span></span><br><span class="line">MYPORT = <span class="number">5684</span></span><br><span class="line">MYGROUP = <span class="string">&#x27;239.192.43.78&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receiver</span>():</span></span><br><span class="line">    <span class="comment"># create a UDP socket</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)</span><br><span class="line">    <span class="comment"># allow multiple sockets to use the same PORT number</span></span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Bind to the port that we know will receive multicast data</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#windows</span></span><br><span class="line">    sock.bind((SENDERIP, MYPORT))</span><br><span class="line">    <span class="comment">#Linux</span></span><br><span class="line">    <span class="comment"># sock.bind((MYGROUP, MYPORT))</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># tell the kernel that we are a multicast socket</span></span><br><span class="line">    <span class="comment"># sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, 255)</span></span><br><span class="line">    <span class="comment"># Tell the kernel that we want to add ourselves to a multicast group</span></span><br><span class="line">    <span class="comment"># The address for the multicast group is the third param</span></span><br><span class="line">    status = sock.setsockopt(socket.IPPROTO_IP,</span><br><span class="line">                             socket.IP_ADD_MEMBERSHIP,</span><br><span class="line">                             socket.inet_aton(MYGROUP) + socket.inet_aton(SENDERIP));</span><br><span class="line"></span><br><span class="line">    sock.setblocking(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># ts = time.time()</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Receive data!&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FROM: &quot;</span>, data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    receiver()</span><br></pre></td></tr></table></figure>

<h1 id="Qt与Python发送图片"><a href="#Qt与Python发送图片" class="headerlink" title="Qt与Python发送图片"></a>Qt与Python发送图片</h1><h2 id="Qt发送"><a href="#Qt发送" class="headerlink" title="Qt发送"></a>Qt发送</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">QString pic=<span class="string">&quot;图片路径&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> QImage vedioimg;</span><br><span class="line">vedioimg.<span class="built_in">load</span>(pic);</span><br><span class="line"></span><br><span class="line">QByteArray ba;</span><br><span class="line"><span class="function">QBuffer <span class="title">buffer</span><span class="params">(&amp;ba)</span></span>;</span><br><span class="line">buffer.<span class="built_in">open</span>(QIODevice::WriteOnly);</span><br><span class="line">vedioimg.<span class="built_in">save</span>(&amp;buffer, <span class="string">&quot;PNG&quot;</span>);</span><br><span class="line"></span><br><span class="line">QString sstr = <span class="string">&quot;video,&quot;</span>+::<span class="built_in">number</span>(ba.<span class="built_in">size</span>())+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">m_udp2-&gt;<span class="built_in">sendMsg</span>(sstr.<span class="built_in">toLocal8Bit</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=ba.<span class="built_in">size</span>()/<span class="number">40000</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(ba.<span class="built_in">size</span>()-i*<span class="number">40000</span>&lt;<span class="number">40000</span>)&#123;</span><br><span class="line">        m_udp2-&gt;<span class="built_in">sendMsg</span>(ba.<span class="built_in">right</span>(ba.<span class="built_in">size</span>()-i*<span class="number">40000</span>));</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">thread</span>()-&gt;<span class="built_in">msleep</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_udp2-&gt;<span class="built_in">sendMsg</span>(ba.<span class="built_in">mid</span>(i*<span class="number">40000</span>,<span class="number">40000</span>));</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">thread</span>()-&gt;<span class="built_in">msleep</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="python接收"><a href="#python接收" class="headerlink" title="python接收"></a>python接收</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> cv2 <span class="keyword">import</span> imwrite</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)</span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">sock.bind((<span class="string">&#x27;192.168.30.10&#x27;</span>, <span class="number">17546</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2image</span>(<span class="params">byte_data</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    byte转为图片</span></span><br><span class="line"><span class="string">    byte_data: 二进制</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    image = Image.<span class="built_in">open</span>(io.BytesIO(byte_data))</span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive_visual_data</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;udp接收可见光图片线程&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;可见光图片接收线程已开启&quot;</span>)</span><br><span class="line">    cnt=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;----------------------------------------------------&quot;</span>)</span><br><span class="line">        rec_data,addr = sock.recvfrom(<span class="number">50000</span>)  <span class="comment"># rec_data:接收到的数据、addr:发送数据的人的IP地址</span></span><br><span class="line">        <span class="keyword">if</span>  <span class="string">&quot;video&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">in</span> rec_data:</span><br><span class="line">            head_str = rec_data.decode()</span><br><span class="line">            head_list = head_str.strip(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">            head_type = head_list[<span class="number">0</span>]</span><br><span class="line">            data_size = <span class="built_in">int</span>(head_list[<span class="number">1</span>])</span><br><span class="line">            <span class="built_in">print</span>(head_type + <span class="string">&quot;,&quot;</span> + <span class="built_in">str</span>(data_size))</span><br><span class="line">            data_total = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            recvd_size = <span class="number">0</span></span><br><span class="line">            rec_time = time.time()</span><br><span class="line">            <span class="keyword">if</span> head_type == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;ddddddd&quot;</span>)</span><br><span class="line">                <span class="keyword">while</span> recvd_size &lt; data_size:</span><br><span class="line">                    data,addr  = sock.recvfrom(<span class="number">40000</span>)</span><br><span class="line">                    <span class="keyword">if</span>  <span class="string">&quot;video&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">in</span> data:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;接收到不正确的flag-video&#x27;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="built_in">len</span>(data))</span><br><span class="line">                    recvd_size += <span class="built_in">len</span>(data)</span><br><span class="line">                    data_total += data</span><br><span class="line">                    <span class="keyword">if</span>  recvd_size == data_size:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;接收到了一张图片&#x27;</span>)</span><br><span class="line">                        cnt+=<span class="number">1</span></span><br><span class="line">                        rec_img = byte2image(data_total)</span><br><span class="line">                        rec_img.save(<span class="string">&quot;video&quot;</span>+ <span class="built_in">str</span>(cnt)+<span class="string">&quot;.png&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    receive_visual_data()</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Smt</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zwlbird.github.io/2021/06/19/TCP/">https://zwlbird.github.io/2021/06/19/TCP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zwlbird.github.io" target="_blank">.oOo.</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/TCP/">TCP</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/06/19/geAVYp3HfN7Kvb6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2021/06/20/%E5%A4%B4%E6%96%87%E4%BB%B6/"><img class="prev-cover" src="https://i.loli.net/2021/06/27/bhoY29lQPvSAr6z.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">头文件</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Smt</div><div class="author-info__description">哇咔咔</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zwlbird/zwlbird.github.io" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zwl931025@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP%E2%80%93UDP"><span class="toc-number">1.</span> <span class="toc-text">TCP–UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-Server-%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">TCP Server 构建流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-client-%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">TCP client 构建流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E4%B8%8BAPI%E7%AE%80%E4%BB%8B"><span class="toc-number">1.3.</span> <span class="toc-text">Windows下API简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-WSAStartup"><span class="toc-number">1.3.1.</span> <span class="toc-text">1 . WSAStartup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-socket"><span class="toc-number">1.3.2.</span> <span class="toc-text">2 . socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-bind"><span class="toc-number">1.3.3.</span> <span class="toc-text">3 . bind</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-listen"><span class="toc-number">1.3.4.</span> <span class="toc-text">4 . listen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-accept"><span class="toc-number">1.3.5.</span> <span class="toc-text">5 . accept</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-closesocket"><span class="toc-number">1.3.6.</span> <span class="toc-text">6 . closesocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-htons"><span class="toc-number">1.3.7.</span> <span class="toc-text">8 . htons</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-recv"><span class="toc-number">1.3.8.</span> <span class="toc-text">9 . recv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-send"><span class="toc-number">1.3.9.</span> <span class="toc-text">10 . send</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-ioctlsocket"><span class="toc-number">1.3.10.</span> <span class="toc-text">11 . ioctlsocket()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8"><span class="toc-number">1.3.11.</span> <span class="toc-text">12.端口复用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E7%BB%84%E6%92%AD"><span class="toc-number">1.3.12.</span> <span class="toc-text">13.组播</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C"><span class="toc-number">1.3.12.1.</span> <span class="toc-text">C++</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Qt"><span class="toc-number">1.3.12.2.</span> <span class="toc-text">Qt</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85TCPServer%E2%80%93Qt-C"><span class="toc-number">1.4.</span> <span class="toc-text">封装TCPServer–Qt+C++</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">怎么使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85TCPServer-%E2%80%93-Qt"><span class="toc-number">1.5.</span> <span class="toc-text">封装TCPServer – Qt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">怎么使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85TCPClient-%E2%80%93-Qt"><span class="toc-number">1.6.</span> <span class="toc-text">封装TCPClient – Qt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-2"><span class="toc-number">1.6.1.</span> <span class="toc-text">怎么使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85UDP-Qt"><span class="toc-number">1.7.</span> <span class="toc-text">封装UDP-Qt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ubuntu"><span class="toc-number">1.7.1.</span> <span class="toc-text">ubuntu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows"><span class="toc-number">1.7.2.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8-3"><span class="toc-number">1.7.3.</span> <span class="toc-text">怎么使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP%E5%87%BD%E6%95%B0-C"><span class="toc-number">1.8.</span> <span class="toc-text">UDP函数-C++</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%BD%91%E5%8D%A1%E4%B8%8B%EF%BC%8CC-UDP%E6%8C%87%E5%AE%9A%E6%BA%90%E7%BB%84%E6%92%AD%E6%94%B6%E4%B8%8D%E5%88%B0%E6%B5%81"><span class="toc-number">2.</span> <span class="toc-text">多网卡下，C++UDP指定源组播收不到流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5"><span class="toc-number">2.1.</span> <span class="toc-text">检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-1"><span class="toc-number">2.2.</span> <span class="toc-text">C++</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Qt%EF%BC%88Linux%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">Qt（Linux）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python"><span class="toc-number">2.4.</span> <span class="toc-text">python</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Qt%E4%B8%8EPython%E5%8F%91%E9%80%81%E5%9B%BE%E7%89%87"><span class="toc-number">3.</span> <span class="toc-text">Qt与Python发送图片</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Qt%E5%8F%91%E9%80%81"><span class="toc-number">3.1.</span> <span class="toc-text">Qt发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python%E6%8E%A5%E6%94%B6"><span class="toc-number">3.2.</span> <span class="toc-text">python接收</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/03/Hexo/" title="Hexo"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo"/></a><div class="content"><a class="title" href="/2022/04/03/Hexo/" title="Hexo">Hexo</a><time datetime="2022-04-02T16:33:52.000Z" title="发表于 2022-04-03 00:33:52">2022-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/31/Android/" title="Android"><img src="https://s2.loli.net/2023/12/12/gfXKlqmwMWzPxH7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android"/></a><div class="content"><a class="title" href="/2021/10/31/Android/" title="Android">Android</a><time datetime="2021-10-31T14:03:21.000Z" title="发表于 2021-10-31 22:03:21">2021-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/19/OpenGL-highlevel/" title="OpenGL-highlevel"><img src="https://s2.loli.net/2023/12/12/zb5QarqSYDHWZs6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenGL-highlevel"/></a><div class="content"><a class="title" href="/2021/10/19/OpenGL-highlevel/" title="OpenGL-highlevel">OpenGL-highlevel</a><time datetime="2021-10-19T13:35:33.000Z" title="发表于 2021-10-19 21:35:33">2021-10-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/17/OpenGL-light/" title="OpenGL-light"><img src="https://s2.loli.net/2023/12/12/Dlf5uYb78R1Firw.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenGL-light"/></a><div class="content"><a class="title" href="/2021/10/17/OpenGL-light/" title="OpenGL-light">OpenGL-light</a><time datetime="2021-10-17T14:09:58.000Z" title="发表于 2021-10-17 22:09:58">2021-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/21/OpenGL-3D/" title="OpenGL_3D"><img src="https://s2.loli.net/2023/12/12/EZS5QGm23HLgvW4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenGL_3D"/></a><div class="content"><a class="title" href="/2021/09/21/OpenGL-3D/" title="OpenGL_3D">OpenGL_3D</a><time datetime="2021-09-21T07:31:53.000Z" title="发表于 2021-09-21 15:31:53">2021-09-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.loli.net/2021/06/19/geAVYp3HfN7Kvb6.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Smt</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'RrMFpOdr0spfIDfRdBukvyf7-gzGzoHsz',
      appKey: 'nipjeGzTyw5yvNk2SgU5KmUQ',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script src="https://myhkw.cn/api/player/162393526192" id="myhk" key="162393526192" m="1"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>